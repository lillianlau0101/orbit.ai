# PRD：orbit.ai 日历日记本（v2.1 增量）

保存路径：`tasks/prd-orbit-ai-calendar-v2.md`

## 1. 增量概述
- 在现有 AI 聊天底子上增加「日历导航 + 日记聚合 + 月视图」
- 允许**同一天写多篇日记**，每篇可选情绪色
- 月视图用**情绪圆点**展示当日状态
- 不破坏原有 `chat` 结构，仅新增 `diary` 集合与日历 UI

## 2. 增量目标
- 14 天内发版，零外部成本
- 日历页日活 ≥ 40%（We 分析 `calendar_open`）
- 日记完成率 ≥ 60%（埋点 `diary_done`）

## 3. 用户故事（增量）

### US-V2-001：日历月视图（情绪色圆点）
- **作为**用户，**我想**一眼看到本月每天的情绪色彩，**以便**了解情绪趋势。
- **验收：**
  - [ ] 月视图格子：已写=用户自选情绪色圆点，未写=空白，今天=蓝色边框
  - [ ] 左右滑动切换月份，无限滚动
  - [ ] 点击日期 → 进入该日日记列表页（多篇卡片）
  - [ ] **dev-browser 验证**圆点颜色与点击跳转

### US-V2-002：同一天多篇日记
- **作为**用户，**我想**一天写多篇日记（不同情绪），**以便**记录变化。
- **验收：**
  - [ ] 日记页顶部显示日期+星期，底部富文本编辑器（≤500 字/篇）
  - [ ] 保存按钮始终可见，每篇独立保存，用 `diary` 集合 `_id` 区分
  - [ ] 每篇保存后可选情绪色（5 星），写入 `mood` 字段
  - [ ] **dev-browser 验证**多篇保存与情绪选择

### US-V2-003：修改/删除日记
- **作为**用户，**我想**修改或删除已写内容，**以便**纠错。
- **验收：**
  - [ ] 日记卡片右上角「⋯」菜单：编辑 / 删除
  - [ ] 编辑：富文本编辑器回填原文，保存即更新
  - [ ] 删除：二次确认，软删除（字段 `deleted: true`）
  - [ ] **dev-browser 验证**编辑回填与删除确认

### US-V2-004：情绪色自定义
- **作为**用户，**我想**自己选情绪圆点颜色，**以便**个性化。
- **验收：**
  - [ ] 设置页新增「情绪配色」：提供 5 组预设（暖色/冷色/莫兰迪...）
  - [ ] 选择后立即生效，月视图实时刷新
  - [ ] 配色存 `user_config` 集合，key=`mood_colors`
  - [ ] **dev-browser 验证**配色切换与月视图刷新

## 4. 增量功能需求
- FR-V2-1：云函数 `getMonthDays` 返回 `{year, month, wrote[{day, mood, color}]}`
- FR-V2-2：云函数 `getDiaryList` 入参 `{year, month, day}` 返回多篇日记数组
- FR-V2-3：云函数 `saveDiary` 入参 `{year, month, day, text, mood, color}`，幂等写入
- FR-V2-4：云函数 `updateDiary` 入参 `{_id, text, mood, color}`，允许修改
- FR-V2-5：云函数 `deleteDiary` 软删除，字段 `deleted: true`
- FR-V2-6：月视图无限滑动，左右切换月份无闪烁
- FR-V2-7：设置页配色选择器，5 组预设，实时生效

## 5. 非目标（v2.1 不做）
- 周视图、年视图、搜索、标签、图片插入、多设备同步、后台提醒、报表

## 6. 设计考虑
- 日历格子 48×48 rpx，情绪圆点 8 rpx，用户自选色
- 日记编辑器 ≤500 字/篇，实时字数提示
- 设置页顶部：「情绪配色」卡片 + 5 组色块选择器

## 7. 技术考虑
- 不破坏原有 `chat` 集合；新增 `diary` 集合，字段：
  `_openid`, `year`, `month`, `day`, `text`, `mood`, `color`, `ts`, `deleted`（bool）
- 定时触发器每月 1 号清理 90 天前 `diary` 与 `chat`（软删除也清）
- 月视图数据：云函数一次性返回当月所有「已写」日期+情绪色数组

## 8. 成功指标（增量）
- 日历页日活 ≥ 40%（`calendar_open` 事件）
- 日记完成率 ≥ 60%（`diary_done` 事件）
- 月视图滑动卡顿率 ≤ 1%（FPS &lt; 50 占比）

## 9. 待澄清问题（已确认）
- ✅ 允许用户修改已写 diary 内容，且一天可写多篇（每次情绪可不同）
- ✅ 月视图显示情绪圆点颜色，用户可在设置页选择配色方案
- ❌ 不接入微信订阅消息提醒「今天还没写日记」

---

✅ **Checklist**
- [x] 增量故事小而可验收
- [x] 功能需求编号、无歧义
- [x] 非目标明确
- [x] 已保存至 `tasks/prd-orbit-ai-calendar-v2.md`

**Next：**
1. 新建 `diary` 集合 + 云函数 `getMonthDays/getDiaryList/saveDiary/updateDiary/deleteDiary`
2. 新建页面 `pages/calendar/calendar` + `pages/diary/diary` + `pages/settings/color-picker`
3. 按 US-V2-001 → US-V2-004 顺序实现 → 推 `main` → 截图验收

